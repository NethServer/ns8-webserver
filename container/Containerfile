# ==========================================================
#  Universal PHP IMAP build for Debian Bullseye/Bookworm
#  Works with PHP < 8.4 (built-in IMAP)
#  Works with PHP >= 8.4 (PECL IMAP)
#  Stops on any error
# ==========================================================

ARG PHP_VERSION_IMAGE
FROM ${PHP_VERSION_IMAGE}

ARG PHP_VERSION_IMAGE
ENV PHP_VERSION_IMAGE=${PHP_VERSION_IMAGE}

# --- Build dependencies for PHP extensions ---
ARG PHP_BUILD_DEPS="\
    libbz2-dev \
    libfreetype6-dev \
    libgmp-dev \
    libicu-dev \
    libjpeg62-turbo-dev \
    libpng-dev \
    libpq-dev \
    libwebp-dev \
    libxml2-dev \
    libxpm-dev \
    libzip-dev \
    libldap2-dev \
    libsasl2-dev \
    libtidy-dev \
    libxslt1-dev \
    libpam0g-dev \
    libssl-dev \
    curl \
    ca-certificates \
    git \
    pkg-config \
    libc-client-dev \
    libkrb5-dev \
"

ARG PHP_EXTENSIONS="\
    bcmath \
    bz2 \
    calendar \
    exif \
    ftp \
    gd \
    gmp \
    intl \
    ldap \
    mysqli \
    opcache \
    pcntl \
    pdo_mysql \
    pdo_pgsql \
    pgsql \
    soap \
    sockets \
    tidy \
    xml \
    xsl \
    zip \
"

# --- Install build deps, compile PHP extensions ---
RUN set -eux \
    # --- Install runtime libraries depending on Debian codename ---
    && apt update \
    && apt upgrade -y \
    &&  if echo "$PHP_VERSION_IMAGE" | grep -q "bullseye$"; then \
            apt install -y --no-install-recommends \
                libc-client2007e \
                libkrb5-3 \
                libpng16-16 \
                libjpeg62-turbo \
                libfreetype6 \
                libwebp6 \
                libxpm4 \
                libpq5 \
                libtidy5deb1 \
                libxslt1.1 \
                libzip4; \
        elif echo "$PHP_VERSION_IMAGE" | grep -q "bookworm$"; then \
            apt install -y --no-install-recommends \
                libc-client2007e \
                libkrb5-3 \
                libpng16-16 \
                libjpeg62-turbo \
                libfreetype6 \
                libwebp7 \
                libxpm4 \
                libpq5 \
                libtidy5deb1 \
                libxslt1.1 \
                libzip4; \
        else \
            echo "Unsupported Debian version: $CODENAME" && exit 1; \
        fi \
    && apt install -y --no-install-recommends $PHP_BUILD_DEPS \
    \
    && docker-php-ext-configure gd \
        --with-freetype=/usr \
        --with-jpeg=/usr \
        --with-webp=/usr \
        --with-xpm=/usr \
    \
    && docker-php-ext-install -j"$(nproc)" $PHP_EXTENSIONS \
    \
    # --- Handle IMAP depending on PHP version ---
    && if php -r 'exit(version_compare(PHP_VERSION,"8.4.0","<")?0:1);'; then \
        docker-php-ext-configure imap --with-kerberos --with-imap-ssl; \
        docker-php-ext-install -j"$(nproc)" imap; \
    else \
        printf "\n" \
            | pecl install imap \
            || { \
                echo 'PECL IMAP install failed'; \
                exit 10; \
            }; \
        docker-php-ext-enable imap; \
    fi \
    \
    # --- Cleanup build deps ---
    && apt purge -y $PHP_BUILD_DEPS \
    && apt autoremove -y \
    && apt clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* \
    && ldconfig \

    # --- Verify all extensions loaded  and their runtime dependencies ---
    # Exit codes:
    # 20 - Missing PHP extension
    # 30 - Missing .so file for extension
    # 40 - Missing runtime dependency for extension
    && for ext in $PHP_EXTENSIONS imap; do \
        php -m \
            | grep -qi "$ext" \
            > /dev/null 2>&1 \
            || { \
                echo "Missing PHP extension: $ext"; \
                exit 20; \
            }; \
        EXT_SO="$(php-config --extension-dir)/${ext}.so"; \
        if [ ! -f "$EXT_SO" ]; then \
            echo "Missing shared object for extension: $ext ($EXT_SO)"; \
            exit 30; \
        fi; \
        if ldd "$EXT_SO" 2>&1 \
            | grep -q "not found"; then \
            echo "Missing runtime dependency for ${ext}.so"; \
            exit 40; \
        fi; \
    done

    # --- Custom PHP configs ---
    COPY docker-php-ext-opcache.ini /usr/local/etc/php/conf.d/docker-php-ext-opcache.ini
    COPY docker-php-ext-imap.ini /usr/local/etc/php/conf.d/docker-php-ext-imap.ini
