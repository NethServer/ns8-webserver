# Define the PHP version via ARG
ARG PHP_VERSION_IMAGE
FROM ${PHP_VERSION_IMAGE}

# Set environment variable for PHP version image
ARG PHP_VERSION_IMAGE
ENV PHP_VERSION_IMAGE=${PHP_VERSION_IMAGE}

# DÃ©pendances de build (compatibles Bullseye/Trixie)
# latest php images does not support php7.4 and php8.0
# we could stick to bullseyes but trixie is the current stable debian release
# so we will try to make it work with both
ARG PHP_BUILD_DEPS="\
    libbz2-dev \
    libfreetype6-dev \
    libgmp-dev \
    libicu-dev \
    libjpeg62-turbo-dev \
    libpng-dev \
    libpq-dev \
    libwebp-dev \
    libxml2-dev \
    libxpm-dev \
    libzip-dev \
    librabbitmq-dev \
    libprotobuf-dev \
    protobuf-compiler \
    libldap2-dev \
    libsasl2-dev \
    libtidy-dev \
    libxslt1-dev \
"

# PHP extensions to install
ARG PHP_EXTENSIONS="\
    bcmath \
    bz2 \
    exif \
    ftp \
    gd \
    gmp \
    intl \
    ldap \
    mysqli \
    opcache \
    pcntl \
    pdo_mysql \
    pdo_pgsql \
    pgsql \
    soap \
    sockets \
    tidy \
    xml \
    xsl \
    zip \
"

# Detect Debian version and set runtime dependencies accordingly
RUN set -eux; \
    if echo "$PHP_VERSION_IMAGE" | grep -q "bullseye$"; then \
        PHP_RUN_DEPS="\
            libbz2-1.0 \
            libfreetype6 \
            libgmp10 \
            libicu67 \
            libjpeg62-turbo \
            libpng16-16 \
            libwebp6 \
            libxml2 \
            libxpm4 \
            libxslt1.1 \
            libzip4 \
            libpq5 \
            tidy \
        "; \
    elif echo "$PHP_VERSION_IMAGE" | grep -q "trixie$"; then \
        PHP_RUN_DEPS="\
            libbz2-1.0 \
            libfreetype6 \
            libgmp10 \
            libicu76 \
            libjpeg62-turbo \
            libpng16-16 \
            libwebp7 \
            libxml2 \
            libxpm4 \
            libxslt1.1 \
            libzip5 \
            libpq5 \
            libtidy58 \
        "; \
    else \
        echo "Unsupported Debian version in PHP_VERSION_IMAGE: $PHP_VERSION_IMAGE"; exit 1; \
    fi; \
    apt-get update && apt-get install -y --no-install-recommends \
        $PHP_BUILD_DEPS \
        $PHP_RUN_DEPS \
    && docker-php-ext-configure gd \
        --with-freetype=/usr \
        --with-jpeg=/usr \
        --with-webp=/usr \
        --with-xpm=/usr \
    && docker-php-ext-install -j$(nproc) $PHP_EXTENSIONS \
    && apt-get remove -y $PHP_BUILD_DEPS \
    && apt-get autoremove -y \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* \
    && ldconfig

COPY docker-php-ext-opcache.ini /usr/local/etc/php/conf.d/docker-php-ext-opcache.ini
